{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/clebe/Desktop/Sistema RH/video-meet-frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { CommonModule } from '@angular/common';\nimport { Client } from '@stomp/stompjs';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/router\";\nimport * as i2 from \"../services/api.service\";\nimport * as i3 from \"@angular/common\";\nconst _c0 = [\"localVideo\"];\nconst _c1 = [\"remoteVideo\"];\nfunction RoomComponent_p_27_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"p\");\n    i0.ɵɵtext(1, \"Reconhecimento de fala n\\u00E3o suportado neste navegador.\");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction RoomComponent_div_28_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r2 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 8)(1, \"button\", 10);\n    i0.ɵɵlistener(\"click\", function RoomComponent_div_28_Template_button_click_1_listener() {\n      i0.ɵɵrestoreView(_r2);\n      const ctx_r2 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r2.toggleTranscription());\n    });\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(ctx_r2.transcribing ? \"Parar\" : \"Transcrever\");\n  }\n}\nconst WS_URL = 'http://localhost:8080/ws';\nexport let RoomComponent = /*#__PURE__*/(() => {\n  class RoomComponent {\n    constructor(route, api) {\n      this.route = route;\n      this.api = api;\n      this.roomId = '';\n      this.clientId = Math.random().toString(36).slice(2);\n      this.inCall = false;\n      this.muted = false;\n      this.transcript = '';\n      this.transcribing = false;\n      this.downloadUrl = '';\n      this.polite = false; // simple tie-breaker\n      this.speechSupported = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;\n    }\n    ngOnInit() {\n      this.roomId = this.route.snapshot.paramMap.get('id') || '';\n      this.downloadUrl = this.api.transcriptDownloadUrl(this.roomId);\n      this.connectSignaling();\n    }\n    ngOnDestroy() {\n      this.stopTranscription();\n      this.stomp?.deactivate();\n      this.pc?.close();\n      this.localStream?.getTracks().forEach(t => t.stop());\n    }\n    connectSignaling() {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        const SockJS = (yield import('sockjs-client')).default;\n        _this.stomp = new Client({\n          webSocketFactory: () => new SockJS(WS_URL),\n          reconnectDelay: 2000\n        });\n        _this.stomp.onConnect = () => {\n          _this.stomp?.subscribe(`/topic/room/${_this.roomId}`, msg => _this.onSignal(msg));\n          _this.send({\n            type: 'join',\n            sender: _this.clientId\n          });\n        };\n        _this.stomp.activate();\n      })();\n    }\n    setupMedia() {\n      var _this2 = this;\n      return _asyncToGenerator(function* () {\n        try {\n          _this2.localStream = yield navigator.mediaDevices.getUserMedia({\n            video: true,\n            audio: true\n          });\n          _this2.localVideo.nativeElement.srcObject = _this2.localStream;\n        } catch (err) {\n          console.error('Erro ao acessar câmera/microfone', err);\n          alert('Não foi possível acessar a câmera/microfone. Verifique as permissões do navegador.');\n          throw err;\n        }\n      })();\n    }\n    startCall() {\n      var _this3 = this;\n      return _asyncToGenerator(function* () {\n        if (_this3.inCall) return;\n        yield _this3.setupMedia();\n        _this3.createPeer();\n        // We will only create offer when we see a 'join' with ordering tie-breaker\n        _this3.inCall = true;\n      })();\n    }\n    createPeer() {\n      var _this4 = this;\n      this.pc = new RTCPeerConnection({\n        iceServers: [{\n          urls: 'stun:stun.l.google.com:19302'\n        }]\n      });\n      this.remoteStream = new MediaStream();\n      this.remoteVideo.nativeElement.srcObject = this.remoteStream;\n      this.localStream?.getTracks().forEach(track => this.pc.addTrack(track, this.localStream));\n      this.pc.onnegotiationneeded = /*#__PURE__*/_asyncToGenerator(function* () {\n        try {\n          yield _this4.makeOffer();\n        } catch (e) {\n          console.warn('Negotiation failed', e);\n        }\n      });\n      this.pc.onicecandidate = e => {\n        if (e.candidate) {\n          this.send({\n            type: 'candidate',\n            candidate: e.candidate\n          });\n        }\n      };\n      this.pc.ontrack = e => {\n        e.streams[0].getTracks().forEach(t => this.remoteStream.addTrack(t));\n      };\n    }\n    makeOffer() {\n      var _this5 = this;\n      return _asyncToGenerator(function* () {\n        if (!_this5.pc) _this5.createPeer();\n        const offer = yield _this5.pc.createOffer();\n        yield _this5.pc.setLocalDescription(offer);\n        _this5.send({\n          type: 'offer',\n          sdp: offer\n        });\n      })();\n    }\n    onSignal(msg) {\n      var _this6 = this;\n      return _asyncToGenerator(function* () {\n        const data = JSON.parse(msg.body);\n        if (data.sender === _this6.clientId) return; // ignore own\n        switch (data.type) {\n          case 'join':\n            {\n              // When someone joins, the lexicographically smaller id sends an offer\n              if (_this6.clientId < (data.sender || '')) {\n                // Ensure we have a peer and local media; if not in a call, still offer receive-only\n                if (!_this6.pc) _this6.createPeer();\n                yield _this6.makeOffer();\n              }\n              break;\n            }\n          case 'offer':\n            {\n              if (!_this6.pc) _this6.createPeer();\n              yield _this6.pc.setRemoteDescription(new RTCSessionDescription(data.sdp));\n              const answer = yield _this6.pc.createAnswer();\n              yield _this6.pc.setLocalDescription(answer);\n              _this6.send({\n                type: 'answer',\n                sdp: answer\n              });\n              break;\n            }\n          case 'answer':\n            {\n              yield _this6.pc?.setRemoteDescription(new RTCSessionDescription(data.sdp));\n              break;\n            }\n          case 'candidate':\n            {\n              try {\n                yield _this6.pc?.addIceCandidate(new RTCIceCandidate(data.candidate));\n              } catch {}\n              break;\n            }\n        }\n      })();\n    }\n    send(payload) {\n      this.stomp?.publish({\n        destination: `/app/room/${this.roomId}`,\n        body: JSON.stringify({\n          ...payload,\n          sender: this.clientId\n        })\n      });\n    }\n    toggleMute() {\n      this.muted = !this.muted;\n      this.localStream?.getAudioTracks().forEach(t => t.enabled = !this.muted);\n    }\n    hangup() {\n      var _this7 = this;\n      return _asyncToGenerator(function* () {\n        _this7.inCall = false;\n        _this7.pc?.close();\n        _this7.pc = undefined;\n        _this7.remoteVideo.nativeElement.srcObject = null;\n        _this7.localStream?.getTracks().forEach(t => t.stop());\n        _this7.localStream = undefined;\n      })();\n    }\n    toggleTranscription() {\n      if (!this.speechSupported) return;\n      if (this.transcribing) {\n        this.stopTranscription();\n      } else {\n        this.startTranscription();\n      }\n    }\n    startTranscription() {\n      const SR = window.webkitSpeechRecognition || window.SpeechRecognition;\n      if (!SR) return;\n      this.recognizer = new SR();\n      this.recognizer.lang = 'pt-BR';\n      this.recognizer.continuous = true;\n      this.recognizer.interimResults = true;\n      this.recognizer.onresult = ev => {\n        let finalText = '';\n        for (let i = ev.resultIndex; i < ev.results.length; i++) {\n          const res = ev.results[i];\n          if (res.isFinal) finalText += res[0].transcript + ' ';\n        }\n        if (finalText) {\n          this.transcript += finalText + '\\n';\n          this.api.appendTranscript(this.roomId, finalText.trim(), 'user').subscribe();\n        }\n      };\n      this.recognizer.start();\n      this.transcribing = true;\n    }\n    stopTranscription() {\n      try {\n        this.recognizer?.stop();\n      } catch {}\n      this.transcribing = false;\n    }\n    static {\n      this.ɵfac = function RoomComponent_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || RoomComponent)(i0.ɵɵdirectiveInject(i1.ActivatedRoute), i0.ɵɵdirectiveInject(i2.ApiService));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: RoomComponent,\n        selectors: [[\"app-room\"]],\n        viewQuery: function RoomComponent_Query(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵviewQuery(_c0, 7);\n            i0.ɵɵviewQuery(_c1, 7);\n          }\n          if (rf & 2) {\n            let _t;\n            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.localVideo = _t.first);\n            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.remoteVideo = _t.first);\n          }\n        },\n        standalone: true,\n        features: [i0.ɵɵStandaloneFeature],\n        decls: 30,\n        vars: 8,\n        consts: [[\"localVideo\", \"\"], [\"remoteVideo\", \"\"], [1, \"card\"], [1, \"row\"], [1, \"col\", \"video-box\"], [1, \"badge\"], [\"autoplay\", \"\", \"playsinline\", \"\", \"muted\", \"\"], [\"autoplay\", \"\", \"playsinline\", \"\"], [1, \"controls\"], [1, \"primary\", 3, \"click\", \"disabled\"], [3, \"click\"], [\"target\", \"_blank\", 3, \"href\"], [1, \"danger\", 3, \"click\", \"disabled\"], [4, \"ngIf\"], [\"class\", \"controls\", 4, \"ngIf\"], [\"readonly\", \"\", 3, \"value\"]],\n        template: function RoomComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            const _r1 = i0.ɵɵgetCurrentView();\n            i0.ɵɵelementStart(0, \"div\", 2)(1, \"h2\");\n            i0.ɵɵtext(2);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(3, \"div\", 3)(4, \"div\", 4)(5, \"div\", 5);\n            i0.ɵɵtext(6, \"Voc\\u00EA\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelement(7, \"video\", 6, 0);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(9, \"div\", 4)(10, \"div\", 5);\n            i0.ɵɵtext(11, \"Remoto\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelement(12, \"video\", 7, 1);\n            i0.ɵɵelementEnd()();\n            i0.ɵɵelementStart(14, \"div\", 8)(15, \"button\", 9);\n            i0.ɵɵlistener(\"click\", function RoomComponent_Template_button_click_15_listener() {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.startCall());\n            });\n            i0.ɵɵtext(16, \"Iniciar\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(17, \"button\", 10);\n            i0.ɵɵlistener(\"click\", function RoomComponent_Template_button_click_17_listener() {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.toggleMute());\n            });\n            i0.ɵɵtext(18);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(19, \"a\", 11)(20, \"button\");\n            i0.ɵɵtext(21, \"Baixar transcri\\u00E7\\u00E3o\");\n            i0.ɵɵelementEnd()();\n            i0.ɵɵelementStart(22, \"button\", 12);\n            i0.ɵɵlistener(\"click\", function RoomComponent_Template_button_click_22_listener() {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.hangup());\n            });\n            i0.ɵɵtext(23, \"Encerrar\");\n            i0.ɵɵelementEnd()()();\n            i0.ɵɵelementStart(24, \"div\", 2)(25, \"h3\");\n            i0.ɵɵtext(26, \"Transcri\\u00E7\\u00E3o (local)\");\n            i0.ɵɵelementEnd();\n            i0.ɵɵtemplate(27, RoomComponent_p_27_Template, 2, 0, \"p\", 13)(28, RoomComponent_div_28_Template, 3, 1, \"div\", 14);\n            i0.ɵɵelement(29, \"textarea\", 15);\n            i0.ɵɵelementEnd();\n          }\n          if (rf & 2) {\n            i0.ɵɵadvance(2);\n            i0.ɵɵtextInterpolate1(\"Sala: \", ctx.roomId, \"\");\n            i0.ɵɵadvance(13);\n            i0.ɵɵproperty(\"disabled\", ctx.inCall);\n            i0.ɵɵadvance(3);\n            i0.ɵɵtextInterpolate(ctx.muted ? \"Desmutar\" : \"Mutar\");\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"href\", ctx.downloadUrl, i0.ɵɵsanitizeUrl);\n            i0.ɵɵadvance(3);\n            i0.ɵɵproperty(\"disabled\", !ctx.inCall);\n            i0.ɵɵadvance(5);\n            i0.ɵɵproperty(\"ngIf\", !ctx.speechSupported);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", ctx.speechSupported);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"value\", ctx.transcript);\n          }\n        },\n        dependencies: [CommonModule, i3.NgIf],\n        encapsulation: 2\n      });\n    }\n  }\n  return RoomComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}